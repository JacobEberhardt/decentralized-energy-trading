# Privacy preserving settlement using ZoKrates

**_ZoKrates_** is a proof-of-concept implementation and provides a toolbox for **_zero-knowledge proofs_**, especially **_zkSNARKs_**, on Ethereum.
In general, ZoKrates enables on-chain verification of off-chain computation such that the key properties of a blockchain are preserved.
It provides a high level programming language for specification and enables generation of proofs of computation which can be verified on-chain due to a generated verifier contract.

## Installation

From [ZoKrates](https://github.com/Zokrates/ZoKrates/blob/master/zokrates_book/src/gettingstarted.md), run `curl -LSfs get.zokrat.es | sh` in order to install ZoKrates.

## Usage

From [ZoKrates](https://github.com/Zokrates/ZoKrates/blob/master/zokrates_book/src/gettingstarted.md), run the phases of the ZoKrates protocol as follows.

```shell
# compile
./zokrates compile -i settlement-check.zok
# perform the setup phase
./zokrates setup
# execute the program
./zokrates compute-witness -a <field[2] hhWithEnergy> <field[2] hhNoEnergy> <field[2] hhWithEnergyNet> <field[2] hhNoEnergyNet> <field[8] hhWithEnergyPacked> <field[8] hhNoEnergyPacked>
# generate a proof of computation
./zokrates generate-proof
# export a solidity verifier
./zokrates export-verifier
```

## `settle.zok` and `settlement-check.zok`

During milestone two, we introduced two design pattern in ZoKrates that match the requirements of the project according to the privacy of household's energy flow.
The first approach `settle.zok` dealt with the implementation of a netting algorithm in ZoKrates high level programming language, mirroring the netting algorithm of the utility contracts of milestone one.
This approach is deprecated, refer to the official documentation for more information on the first approach.

For the rest of this short description, we refer to the second approach.
The second approach `settlement-check.zok` assumes netting as being similar of how NP-complete problems are described: an algorithm that is hard to compute, but relatively easy to verify.
Here, netting is performed off-chain whereas the ZoKrates code is implemented to merely validate certain key properties, or invariants, that describe a valid settlement algorithm.
A total of four invariants are defined to describe a set of settlement algorithms in which our netting algorithm is an element of it without being too lax or too strict.

### Consistency and fairness

Let $\vec{h}$ be the energy state of all households, $e_r,e_a$ its total required and available energy amount, and $S$ an arbitrary settlement algorithm. We now define the invariants as follows:

**_Consistency:_** After a successful settlement the total energy balance of the system remains unchanged, i.e. energy is never artificially lost or introduced into the system.
In other words, neither energy is lost nor energy is generated by the settlement algorithm.
\[e_a(\vec{h}) + e_r(\vec{h}) = e_a(S(\vec{h})) + e_r(S(\vec{h}))\]
While this invariant is the weakest of all, it is also the most fundamental that captures all valid settlement algorithms.
The next ones act as refinement so that the remaining sets of settlement algorithms move toward better fairness.

**_Weak fairness:_** Assuming requiring and contributing households\footnote{Requiring households demand energy whereas contributing households share unspent energy during the settlement.}, weak fairness indicates that after a successful settlement no requiring household demands more energy and no contributing household shares more energy than before.
\[|S(\vec{h})\_i| \leq |\vec{h}\_i|\]
Simply, a settlement never makes things worse.

**_Threshold fairness:_** Assuming requiring, contributing households and some threshold $f$, fairness up to threshold $f$ indicates that after a successful settlement any requiring household received and any contributing household shared up to threshold $h$ energy.
Analogous definition holds for a percentage threshold $f$, i.e. after a successful settlement any requiring household received and any contributing household shared up to percentage threshold $f$ energy according to their total requiring or contributing energy.
\[|S(\vec{h})\_i| \leq |\vec{h}\_i| + f_i(\vec{h})\]
where the functional $f_i$ are chosen to serve as a threshold, whether it is constant or proportional.
Building upon the previous invariant, this limits extreme cases for selfishly designed algorithms, e.g. situations where only one household is allowed to distribute or consume.

**_Proportional fairness:_** Assuming requiring, contributing households, their corresponding required, contributed energy, total required and total contributed energy, proportional fairness is two-folded due to the net energy of total required and contributed energy.
On the one hand, consider \emph{total required energy is greater than total contributed energy}, i.e. more energy is required than it can be fulfilled actually.
In this case, all requiring households claim a proportion from the total contributed energy based on their required energy relative to the total required energy.
On the other hand, consider \emph{total contributed energy greater than total required energy}, i.e. more energy is contributed than currently required.
In the second case, all contributing households distribute some contributed energy that is equal to the ratio of the total contributed energy scaled to the total required energy.
Moreover, in the case \emph{total contributed energy is equal to total required energy}, any of the two cases above hold.
\[e_a(\vec{h}) > |e_r(\vec{h})| \Rightarrow e_r(S(\vec{h})) = 0 \\
e_a(\vec{h}) \leq |e_r(\vec{h})| \Rightarrow e_a(S(\vec{h})) = 0\]
Lastly, this fairness property leads to a state where the total required or total contributed energy of at least one set of the households\footnote{Requiring or contributing households.} is equal to zero after a successful settlement.
This final invariant causes fitting algorithms to guarantee that a set of households settle with a zero sum energy production value.

### Proportional fairness up to epsilon

The ZoKrates `settlement-check.zok` implements validation checks for two of the above described properties: **_consistency_** and **_proportional fairness_**.
Given the required and contributed energy amount of participating households before and after a successful settlement, `settlement-check.zok` validates whether the netting result is consistent and proportional fair up to a predefined static epsilon error.
